#
# Copyright (c) 2019-2020 P3TERX <https://p3terx.com>
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#
# https://github.com/P3TERX/Actions-OpenWrt
# Description: Build OpenWrt using GitHub Actions
#

name: N1 packit

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      UPLOAD_FIRMWARE:
        required: false
        default: 'false'
        type: choice
        options:
         - 'false'
         - 'true'
      UPLOAD_RELEASE:
        required: false
        default: 'true'
        type: choice
        options:
         - 'false'
         - 'true'


jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        docker rmi `docker images -q`
          [[ -n "${AGENT_TOOLSDIRECTORY}" ]] && sudo rm -rf "${AGENT_TOOLSDIRECTORY}"
          sudo rm -rf /usr/share/dotnet /etc/apt/sources.list.d /usr/local/lib/android 2>/dev/null
          sudo -E apt-get -y update
          sudo -E apt-get -y purge azure-cli ghc* zulu* llvm* firefox google* dotnet* powershell openjdk* mongodb* moby* || true
          sudo -E apt-get -y install $(curl -fsSL https://is.gd/depend_ubuntu2204_openwrt)
          sudo -E systemctl daemon-reload
          sudo -E apt-get -y autoremove --purge
          sudo -E apt-get clean
          sudo mkdir -p /mnt/workdir
          sudo chown ${USER}:${GROUPS} /mnt/workdir
          sudo timedatectl set-timezone "${TZ}"
          echo "status=success" >> ${GITHUB_OUTPUT}
    - name: Download previous release asset
      uses: robinraju/release-downloader@v1.8
      with:
        repository: ${{ github.repository }}  # 本仓库，默认就是这个
        tag: "2025.03.30-0213-lede_n1_OK_latest"                         # 指定以前的 tag（不写 latest 就是以前的）
        fileName: "openwrt-armvirt-64-generic-rootfs.tar.gz"             # 要下载的文件名，支持 "*.tar.gz" 通配
        # extract: true                       # 可选：自动解压（如果文件是 zip/tar/tar.gz）
        out-file-path: "/mnt/workdir"      # 可选：下载到这个文件夹    




    - name: Build OpenWrt firmware
      uses: unifreq/openwrt_packit@master
      env:
        OPENWRT_ARMVIRT: /mnt/workdir/*rootfs.tar.gz
        PACKAGE_SOC: s905d
        #KERNEL_VERSION_NAME: 5.15.95_6.1.15
        KERNEL_VERSION_NAME: 5.10.233
        KERNEL_AUTO_LATEST: false        
    - name: Generate release tag
      id: tag
      run: |
        echo "release_tag=$(date +"%Y.%m.%d-%H%M")"-${{ github.ref_name }} >> $GITHUB_OUTPUT        
        touch release.txt
        echo "status=success" >> $GITHUB_OUTPUT        
        
    - name: Upload firmware to release
      uses:  ncipollo/release-action@main
      if: steps.tag.outputs.status == 'success' && !cancelled()
      with:
        tag: ${{ steps.tag.outputs.release_tag }}
        body: |
          This is OpenWrt firmware for Amlogic N1 box
          * Firmware information
          Default IP: 192.168.19.1
          Default username: root
        artifacts: ${{ env.FIRMWARE }}/openwrt-armvirt-64-generic.manifest,${{ env.FIRMWARE }}/config.buildinfo,${{ env.PACKAGED_OUTPUTPATH }}/*.gz
        
    - name: Delete workflow runs
      uses: Mattraks/delete-workflow-runs@v2
      with:
        token: ${{ github.token }}
        repository: ${{ github.repository }}
        retain_days: 30
        keep_minimum_runs: 6  
